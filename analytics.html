<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitChef IA - Dashboard Analytics</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #333;
      font-size: 2rem;
    }

    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s;
    }

    .metric-card:hover {
      transform: translateY(-5px);
    }

    .metric-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .metric-value {
      color: #333;
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .metric-change {
      font-size: 0.9rem;
      color: #4caf50;
    }

    .metric-change.negative {
      color: #f44336;
    }

    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .chart-title {
      color: #333;
      font-size: 1.3rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .ingredients-list {
      list-style: none;
    }

    .ingredient-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: #f8f8f8;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .ingredient-item:hover {
      background: #f0f0f0;
    }

    .ingredient-name {
      font-weight: 600;
      color: #333;
    }

    .ingredient-count {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .events-log {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-height: 400px;
      overflow-y: auto;
    }

    .event-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #fafafa;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .event-time {
      color: #999;
      margin-right: 15px;
      min-width: 60px;
    }

    .event-type {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      margin-right: 10px;
      font-size: 0.8rem;
    }

    .event-details {
      color: #555;
      flex: 1;
    }

    .time-range-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .time-btn {
      padding: 8px 16px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .time-btn.active {
      background: #667eea;
      color: white;
    }

    .export-btn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 10px;
    }

    .clear-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Dashboard Analytics - FitChef IA</h1>
    <div>
      <button class="export-btn" onclick="exportData()">üì• Exportar Dados</button>
      <button class="clear-btn" onclick="clearData()">üóëÔ∏è Limpar</button>
      <button class="refresh-btn" onclick="refreshMetrics()">üîÑ Atualizar</button>
    </div>
  </div>

  <!-- M√©tricas Principais -->
  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">Total de Sess√µes</div>
      <div class="metric-value" id="totalSessions">0</div>
      <div class="metric-change">Desde o in√≠cio</div>
    </div>
    
    <div class="metric-card">
      <div class="metric-label">Buscas Realizadas</div>
      <div class="metric-value" id="totalSearches">0</div>
      <div class="metric-change">Total acumulado</div>
    </div>
    
    <div class="metric-card">
      <div class="metric-label">M√©dia de Ingredientes</div>
      <div class="metric-value" id="avgIngredients">0</div>
      <div class="metric-change">Por busca</div>
    </div>
    
    <div class="metric-card">
      <div class="metric-label">Taxa de Sucesso</div>
      <div class="metric-value" id="successRate">0%</div>
      <div class="metric-change">Buscas com resultados</div>
    </div>
  </div>

  <!-- Top Ingredientes -->
  <div class="chart-container">
    <h2 class="chart-title">ü•ò Top 10 Ingredientes Mais Buscados</h2>
    <ul class="ingredients-list" id="topIngredients">
      <li class="no-data">Nenhum dado dispon√≠vel ainda</li>
    </ul>
  </div>

  <!-- Eventos Recentes -->
  <div class="chart-container">
    <h2 class="chart-title">üìù Eventos Recentes</h2>
    <div class="events-log" id="eventsLog">
      <div class="no-data">Nenhum evento registrado</div>
    </div>
  </div>

  <script>
    // Carrega dados do localStorage
    function loadAnalyticsData() {
      const storageKey = 'fitchef_analytics';
      const data = JSON.parse(localStorage.getItem(storageKey) || '[]');
      return data;
    }

    // Calcula m√©tricas
    function calculateMetrics() {
      const data = loadAnalyticsData();
      
      // Total de sess√µes
      const totalSessions = data.length;
      
      // Total de buscas
      let totalSearches = 0;
      let successfulSearches = 0;
      let totalIngredients = 0;
      let searchCount = 0;
      const ingredientsMap = {};
      const recentEvents = [];
      
      data.forEach(session => {
        if (session.events) {
          session.events.forEach(event => {
            // Adiciona aos eventos recentes
            recentEvents.push({
              ...event,
              sessionId: session.sessionId,
              date: session.date
            });
            
            if (event.event === 'search_started') {
              totalSearches++;
              searchCount++;
              if (event.parameters && event.parameters.ingredients_count) {
                totalIngredients += event.parameters.ingredients_count;
              }
              
              // Conta ingredientes individuais
              if (event.parameters && event.parameters.ingredients) {
                event.parameters.ingredients.forEach(ing => {
                  ingredientsMap[ing] = (ingredientsMap[ing] || 0) + 1;
                });
              }
            }
            
            if (event.event === 'search_success') {
              successfulSearches++;
            }
          });
        }
      });
      
      // Calcula m√©dias
      const avgIngredients = searchCount > 0 ? (totalIngredients / searchCount).toFixed(1) : 0;
      const successRate = totalSearches > 0 ? ((successfulSearches / totalSearches) * 100).toFixed(1) : 0;
      
      // Ordena ingredientes por frequ√™ncia
      const topIngredients = Object.entries(ingredientsMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([ingredient, count]) => ({ ingredient, count }));
      
      // Ordena eventos por data
      recentEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      return {
        totalSessions,
        totalSearches,
        avgIngredients,
        successRate,
        topIngredients,
        recentEvents: recentEvents.slice(0, 50) // √öltimos 50 eventos
      };
    }

    // Atualiza a interface
    function updateUI() {
      const metrics = calculateMetrics();
      
      // Atualiza cards de m√©tricas
      document.getElementById('totalSessions').textContent = metrics.totalSessions;
      document.getElementById('totalSearches').textContent = metrics.totalSearches;
      document.getElementById('avgIngredients').textContent = metrics.avgIngredients;
      document.getElementById('successRate').textContent = metrics.successRate + '%';
      
      // Atualiza top ingredientes
      const ingredientsList = document.getElementById('topIngredients');
      if (metrics.topIngredients.length > 0) {
        ingredientsList.innerHTML = metrics.topIngredients.map((item, index) => {
          const maxCount = metrics.topIngredients[0].count;
          const percentage = (item.count / maxCount) * 100;
          
          return `
            <li class="ingredient-item">
              <span class="ingredient-name">${index + 1}. ${item.ingredient}</span>
              <span class="ingredient-count">${item.count} buscas</span>
              <div class="progress-bar" style="position: absolute; bottom: 0; left: 0; right: 0;">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
            </li>
          `;
        }).join('');
      }
      
      // Atualiza eventos recentes
      const eventsLog = document.getElementById('eventsLog');
      if (metrics.recentEvents.length > 0) {
        eventsLog.innerHTML = metrics.recentEvents.map(event => {
          const time = new Date(event.timestamp).toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          let eventLabel = event.event;
          let eventDetails = '';
          
          switch(event.event) {
            case 'page_view':
              eventLabel = 'Visita';
              eventDetails = 'P√°gina inicial carregada';
              break;
            case 'search_started':
              eventLabel = 'Busca';
              eventDetails = `${event.parameters.ingredients_count} ingredientes`;
              break;
            case 'search_success':
              eventLabel = 'Sucesso';
              eventDetails = `${event.parameters.recipes_found} receitas encontradas`;
              break;
            case 'search_failed':
              eventLabel = 'Erro';
              eventDetails = event.parameters.error_message;
              break;
            case 'ingredient_added':
              eventLabel = 'Ingrediente';
              eventDetails = `Adicionado: ${event.parameters.ingredient}`;
              break;
            default:
              eventDetails = JSON.stringify(event.parameters || {});
          }
          
          return `
            <div class="event-item">
              <span class="event-time">${time}</span>
              <span class="event-type">${eventLabel}</span>
              <span class="event-details">${eventDetails}</span>
            </div>
          `;
        }).join('');
      }
    }

    // Exporta dados para CSV
    function exportData() {
      const metrics = calculateMetrics();
      
      let csv = 'M√©trica,Valor\n';
      csv += `Total de Sess√µes,${metrics.totalSessions}\n`;
      csv += `Total de Buscas,${metrics.totalSearches}\n`;
      csv += `M√©dia de Ingredientes,${metrics.avgIngredients}\n`;
      csv += `Taxa de Sucesso,${metrics.successRate}%\n\n`;
      
      csv += 'Top Ingredientes,Quantidade\n';
      metrics.topIngredients.forEach(item => {
        csv += `${item.ingredient},${item.count}\n`;
      });
      
      csv += '\nEventos Recentes\n';
      csv += 'Timestamp,Evento,Detalhes\n';
      metrics.recentEvents.forEach(event => {
        csv += `${event.timestamp},${event.event},"${JSON.stringify(event.parameters || {})}"\n`;
      });
      
      // Download do arquivo
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `fitchef_analytics_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // Limpa dados
    function clearData() {
      if (confirm('Tem certeza que deseja limpar todos os dados de analytics?')) {
        localStorage.removeItem('fitchef_analytics');
        updateUI();
        alert('Dados limpos com sucesso!');
      }
    }

    // Atualiza m√©tricas
    function refreshMetrics() {
      updateUI();
      
      // Feedback visual
      const btn = document.querySelector('.refresh-btn');
      btn.textContent = '‚úÖ Atualizado!';
      setTimeout(() => {
        btn.textContent = 'üîÑ Atualizar';
      }, 2000);
    }

    // Carrega dados ao abrir a p√°gina
    window.addEventListener('load', () => {
      updateUI();
      
      // Auto-refresh a cada 10 segundos
      setInterval(updateUI, 10000);
    });

    // Atalhos de teclado
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        refreshMetrics();
      }
      if (e.key === 'e' && e.ctrlKey) {
        e.preventDefault();
        exportData();
      }
    });
  </script>
</body>
</html>