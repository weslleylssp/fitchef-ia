<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitChef IA - Dashboard Analytics</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .header h1 {
      font-size: 1.8rem;
      color: #333;
    }

    .btn {
      border: none;
      border-radius: 25px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover { transform: translateY(-2px); }

    .export-btn { background: #4caf50; color: white; }
    .clear-btn { background: #f44336; color: white; }
    .refresh-btn { background: #667eea; color: white; }
    .inspect-btn { background: #ffa000; color: white; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s;
    }

    .metric-card:hover { transform: translateY(-5px); }
    .metric-label { color: #666; font-size: 0.9rem; margin-bottom: 8px; }
    .metric-value { font-size: 2.4rem; font-weight: bold; }

    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .chart-title {
      font-size: 1.3rem;
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 15px;
      padding-bottom: 5px;
    }

    .ingredients-list { list-style: none; }
    .ingredient-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .ingredient-count {
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.9rem;
    }

    .events-log {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-height: 400px;
      overflow-y: auto;
    }

    .event-item {
      background: #fafafa;
      border-radius: 8px;
      margin-bottom: 8px;
      padding: 10px;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    .event-time { color: #999; margin-right: 15px; min-width: 60px; }
    .event-type {
      background: #e3f2fd;
      color: #1976d2;
      padding: 3px 8px;
      border-radius: 12px;
      margin-right: 10px;
      font-size: 0.8rem;
      text-transform: capitalize;
    }
    .no-data { text-align: center; padding: 20px; color: #999; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Dashboard Analytics - FitChef IA</h1>
    <div>
      <button class="btn export-btn" onclick="exportData()">üì• Exportar</button>
      <button class="btn inspect-btn" onclick="inspectData()">üîç Ver Dados</button>
      <button class="btn clear-btn" onclick="clearData()">üóëÔ∏è Limpar</button>
      <button class="btn refresh-btn" onclick="refreshMetrics()">üîÑ Atualizar</button>
    </div>
  </div>

  <!-- M√©tricas principais -->
  <div class="metrics-grid">
    <div class="metric-card"><div class="metric-label">Total de Sess√µes</div><div class="metric-value" id="totalSessions">0</div></div>
    <div class="metric-card"><div class="metric-label">Buscas Realizadas</div><div class="metric-value" id="totalSearches">0</div></div>
    <div class="metric-card"><div class="metric-label">M√©dia de Ingredientes</div><div class="metric-value" id="avgIngredients">0</div></div>
    <div class="metric-card"><div class="metric-label">Taxa de Sucesso</div><div class="metric-value" id="successRate">0%</div></div>
    <div class="metric-card"><div class="metric-label">Resultados Visualizados</div><div class="metric-value" id="resultsViewed">0</div></div>
  </div>

  <!-- Top ingredientes -->
  <div class="chart-container">
    <h2 class="chart-title">ü•ò Top 10 Ingredientes Mais Buscados</h2>
    <ul class="ingredients-list" id="topIngredients"><li class="no-data">Nenhum dado dispon√≠vel ainda</li></ul>
  </div>

  <!-- Eventos -->
  <div class="chart-container">
    <h2 class="chart-title">üìù Eventos Recentes</h2>
    <div class="events-log" id="eventsLog"><div class="no-data">Nenhum evento registrado</div></div>
  </div>

  <script>
    function loadData() {
      return JSON.parse(localStorage.getItem('fitchef_analytics') || '[]');
    }

    function analyzeData() {
      const events = loadData();
      const sessions = new Set();
      let totalSearches = 0, totalSuccess = 0, totalIngredients = 0, resultsViewed = 0;
      const ingredientsMap = {};

      events.forEach(ev => {
        if (ev.sessionId) sessions.add(ev.sessionId);

        switch (ev.event) {
          case 'search_started':
            totalSearches++;
            if (ev.parameters.ingredients) {
              ev.parameters.ingredients.forEach(i => ingredientsMap[i] = (ingredientsMap[i] || 0) + 1);
            }
            totalIngredients += ev.parameters.ingredients_count || 0;
            break;
          case 'search_success': totalSuccess++; break;
          case 'results_page_view': resultsViewed++; break;
        }
      });

      const avgIngredients = totalSearches ? (totalIngredients / totalSearches).toFixed(1) : 0;
      const successRate = totalSearches ? ((totalSuccess / totalSearches) * 100).toFixed(1) : 0;

      const topIngredients = Object.entries(ingredientsMap)
        .sort((a,b)=>b[1]-a[1]).slice(0,10)
        .map(([ingredient,count])=>({ingredient,count}));

      const sortedEvents = [...events].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

      return {
        totalSessions: sessions.size,
        totalSearches,
        avgIngredients,
        successRate,
        resultsViewed,
        topIngredients,
        recentEvents: sortedEvents.slice(0,50)
      };
    }

    function updateUI() {
      const metrics = analyzeData();
      document.getElementById('totalSessions').textContent = metrics.totalSessions;
      document.getElementById('totalSearches').textContent = metrics.totalSearches;
      document.getElementById('avgIngredients').textContent = metrics.avgIngredients;
      document.getElementById('successRate').textContent = metrics.successRate + '%';
      document.getElementById('resultsViewed').textContent = metrics.resultsViewed;

      // Top ingredientes
      const list = document.getElementById('topIngredients');
      if (metrics.topIngredients.length === 0) {
        list.innerHTML = '<li class="no-data">Nenhum dado dispon√≠vel ainda</li>';
      } else {
        const max = metrics.topIngredients[0].count;
        list.innerHTML = metrics.topIngredients.map((i,idx)=>{
          const pct=(i.count/max)*100;
          return `
            <li class="ingredient-item">
              <span>${idx+1}. ${i.ingredient}</span>
              <span class="ingredient-count">${i.count}</span>
              <div style="background:#e0e0e0;height:6px;width:100%;border-radius:5px;margin-top:4px;">
                <div style="width:${pct}%;height:6px;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:5px;"></div>
              </div>
            </li>`;
        }).join('');
      }

      // Eventos recentes
      const log = document.getElementById('eventsLog');
      if (metrics.recentEvents.length === 0) {
        log.innerHTML = '<div class="no-data">Nenhum evento registrado</div>';
      } else {
        log.innerHTML = metrics.recentEvents.map(e=>{
          const time=new Date(e.timestamp).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
          return `<div class="event-item">
            <span class="event-time">${time}</span>
            <span class="event-type">${e.event}</span>
            <span>${JSON.stringify(e.parameters||{})}</span>
          </div>`;
        }).join('');
      }
    }

    function refreshMetrics() {
      updateUI();
      const btn=document.querySelector('.refresh-btn');
      btn.textContent='‚úÖ Atualizado';
      setTimeout(()=>btn.textContent='üîÑ Atualizar',2000);
    }

    function exportData() {
      const data=analyzeData();
      let csv='Evento,Timestamp,Par√¢metros\n';
      loadData().forEach(e=>{
        csv+=`${e.event},${e.timestamp},"${JSON.stringify(e.parameters)}"\n`;
      });
      const blob=new Blob([csv],{type:'text/csv'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=`fitchef_analytics_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function clearData() {
      if (confirm('Tem certeza que deseja apagar todos os dados?')) {
        localStorage.removeItem('fitchef_analytics');
        updateUI();
        alert('Dados limpos com sucesso.');
      }
    }

    function inspectData() {
      const data=loadData();
      alert(`Total de eventos salvos: ${data.length}\n\n` + JSON.stringify(data.slice(-5),null,2));
    }

    window.addEventListener('load',()=>{
      updateUI();
      setInterval(updateUI,10000);
    });
  </script>
</body>
</html>
